---
import Link from '@/components/Link/Link.astro'

import Section from '../Section.astro'

interface LinkData {
	id: number
	title: string
	url: string
	tags: string
	date: string
}

let linksData: LinkData[] = []
try {
	const response = await fetch(`${Astro.url.origin}/api/links.json`)
	if (response.ok) {
		linksData = await response.json()
	} else {
		console.error(
			'Failed to fetch links:',
			response.status,
			response.statusText,
		)
	}
} catch (error) {
	console.error('Error fetching links:', error)
	// Fallback to empty array if API is not available
	linksData = []
}

// Filter out future-dated links and get only live content
const today = new Date()
const todayDateString = today.toISOString().split('T')[0] // Get YYYY-MM-DD format

const liveLinks = linksData.filter((link: LinkData) => {
	return link.date <= todayDateString
})

const sortedLinks = liveLinks.sort(
	(a: LinkData, b: LinkData) =>
		new Date(b.date).getTime() - new Date(a.date).getTime(),
)
const topLinks = sortedLinks.slice(0, 6)
---

<Section ariaLabel="Latest Social Links">
	<h3
		class="my-3 flex w-full justify-center-safe gap-2 text-center text-xl font-bold text-slate-800 dark:text-slate-200">
		<Link
			href="/links/"
			title="Latest Social Links"
			text="Latest Social Links"
			class="hover:text-blue-600 hover:underline dark:hover:text-blue-400"
		/>
		<a
			href="/rss-links.xml"
			class="inline-flex items-center gap-1.5 rounded-md bg-orange-50 px-3 py-1.5 text-sm font-medium text-orange-700 transition-colors hover:bg-orange-100 dark:bg-orange-400/10 dark:text-orange-400 dark:hover:bg-orange-400/20"
			title="Subscribe to links RSS feed"
			aria-label="Subscribe to links RSS feed">
			<svg class="h-4 w-4" fill="currentColor" viewBox="0 0 20 20">
				<path
					fill-rule="evenodd"
					d="M3.429 2.929c.444-.444 1.143-.444 1.587 0 .444.444.444 1.143 0 1.587a6 6 0 000 8.485c-.444.444-1.143.444-1.587 0-.444-.444-.444-1.143 0-1.587a4 4 0 010-5.656c.444-.444.444-1.143 0-1.587z"
					clip-rule="evenodd">
				</path>
				<path
					fill-rule="evenodd"
					d="M7.05 6.464c.444-.444 1.143-.444 1.587 0 .444.444.444 1.143 0 1.587a2 2 0 010 2.83c-.444.444-1.143.444-1.587 0-.444-.444-.444-1.143 0-1.587.195-.195.195-.512 0-.707-.444-.444-.444-1.143 0-1.587z"
					clip-rule="evenodd">
				</path>
				<circle cx="11" cy="13" r="1"></circle>
			</svg>
			Links Feed
		</a>
	</h3>

	<div class="mt-3 flex w-full flex-col items-center gap-4">
		{
			topLinks.map((l: LinkData, i: number) => (
				<article
					class="article-animate flex w-full max-w-xl flex-row items-center gap-2 border-b-2 border-slate-200 p-1 dark:border-slate-700"
					style={`animation-delay: ${i * 500}ms`}>
					<h4 class="mb-1 truncate text-xs font-bold text-slate-900 md:text-lg dark:text-slate-100">
						<Link
							href={l.url}
							target="_blank"
							title={l.title}
							text={l.title}
							class="truncate transition-colors hover:text-blue-600 hover:underline dark:hover:text-blue-400"
						/>
					</h4>
					<span>
						{''} - {''}
					</span>
					<time
						class="text-xs text-slate-500 dark:text-slate-400"
						datetime={new Date(l.date).toISOString()}>
						{new Date(l.date).toLocaleDateString('en-us', {
							month: '2-digit',
							day: '2-digit',
						})}
					</time>
				</article>
			))
		}
	</div>
</Section>

<style>
	@keyframes fadeInUp {
		from {
			opacity: 0;
			transform: translateY(30px);
		}
		to {
			opacity: 1;
			transform: translateY(0);
		}
	}
	.article-animate {
		opacity: 0;
		animation: fadeInUp 0.6s forwards;
	}
</style>
