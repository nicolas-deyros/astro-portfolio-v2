---
import AdminLinksManager from '@components/Admin/AdminLinksManager'
import Layout from '@layouts/index.astro'
import { count, db, like, Links as LinksTable, or, sql } from 'astro:db'

const { url } = Astro.request
const searchParams = new URL(url).searchParams

// Pagination parameters
const page = parseInt(searchParams.get('page') || '1')
const pageSize = parseInt(searchParams.get('pageSize') || '10')

// Sorting parameters
const sort = (searchParams.get('sort') || 'date') as
	| 'title'
	| 'url'
	| 'tags'
	| 'date'
const dir = (searchParams.get('dir') || 'desc') as 'asc' | 'desc'

// Filter parameters
const search = searchParams.get('search') || ''
const tag = searchParams.get('tag') || ''

interface LinkData {
	id: number
	title: string
	url: string
	tags: string
	date: string
}

interface PaginationData {
	page: number
	pageSize: number
	total: number
	totalPages: number
	hasNext: boolean
	hasPrev: boolean
}

// Server-side data fetching with advanced filtering and pagination
let links: LinkData[] = []
let pagination: PaginationData = {
	page: 1,
	pageSize: 10,
	total: 0,
	totalPages: 0,
	hasNext: false,
	hasPrev: false,
}
let availableTags: string[] = []

try {
	const offset = (page - 1) * pageSize

	// Build base queries
	let query = db.select().from(LinksTable)
	let countQuery = db.select({ count: count() }).from(LinksTable)

	// Add search conditions
	if (search) {
		const searchCondition = or(
			like(LinksTable.title, `%${search}%`),
			like(LinksTable.url, `%${search}%`),
			like(LinksTable.tags, `%${search}%`),
		)
		query = query.where(searchCondition) as typeof query
		countQuery = countQuery.where(searchCondition) as typeof countQuery
	}

	// Add tag filter
	if (tag) {
		const tagCondition = like(LinksTable.tags, `%${tag}%`)
		query = query.where(tagCondition) as typeof query
		countQuery = countQuery.where(tagCondition) as typeof countQuery
	}

	// Add sorting
	const orderColumn = LinksTable[sort]
	if (dir === 'asc') {
		query = query.orderBy(orderColumn) as typeof query
	} else {
		query = query.orderBy(sql`${orderColumn} DESC`) as typeof query
	}

	// Add pagination
	query = query.limit(pageSize).offset(offset) as typeof query

	// Execute queries
	const [dbLinks, totalResult, allLinks] = await Promise.all([
		query,
		countQuery,
		db.select({ tags: LinksTable.tags }).from(LinksTable), // For extracting all tags
	])

	// Process results
	links = dbLinks.map(link => ({
		id: link.id,
		title: link.title,
		url: link.url,
		tags: link.tags,
		date: link.date,
	}))

	const total = totalResult[0]?.count || 0
	const totalPages = Math.ceil(total / pageSize)

	pagination = {
		page,
		pageSize,
		total,
		totalPages,
		hasNext: page < totalPages,
		hasPrev: page > 1,
	}

	// Extract unique tags for filter dropdown
	const allTags = new Set<string>()
	allLinks.forEach(link => {
		if (link.tags) {
			link.tags.split(',').forEach(tagItem => {
				const cleanTag = tagItem.trim()
				if (cleanTag) allTags.add(cleanTag)
			})
		}
	})
	availableTags = Array.from(allTags).sort()

	console.log(
		`Loaded ${links.length} of ${total} links (page ${page}/${totalPages}), sorted by ${sort} ${dir}, search: "${search}", tag: "${tag}"`,
	)
} catch (error) {
	console.error('Error fetching links from database:', error)
	links = []
}
---

<Layout title="Admin | Link Management">
	<!-- ðŸ”’ This content is only served to authenticated users thanks to server-side checks -->
	<div class="min-h-screen bg-white dark:bg-gray-900">
		<AdminLinksManager
			client:load
			initialLinks={links}
			initialPagination={pagination}
			availableTags={availableTags}
			initialSort={sort}
			initialDir={dir}
			initialSearch={search}
			initialTag={tag}
		/>
	</div>
</Layout>
