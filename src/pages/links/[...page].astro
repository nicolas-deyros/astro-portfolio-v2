---
export const prerender = false
import Pagination from '@components/Pagination.astro'
import Section from '@components/Section.astro'
import Layout from '@layouts/index.astro'
import { db, Links } from 'astro:db'

interface LinkData {
	id: number
	title: string
	url: string
	tags: string
	date: string
}

// Get page number from URL params
const pageParam = Astro.params.page
const currentPage = pageParam
	? Array.isArray(pageParam)
		? parseInt(pageParam[0])
		: parseInt(pageParam)
	: 1
const pageSize = 12

// Get tag filter from URL search params
const url = new URL(Astro.request.url)
const selectedTag = url.searchParams.get('tag')

// Fetch all links from the database
const linksData = await db.select().from(Links)

// Filter out future-dated links and get only live content
const today = new Date()
const todayDateString = today.toISOString().split('T')[0] // Get YYYY-MM-DD format

const liveLinks = linksData.filter((link: LinkData) => {
	return link.date <= todayDateString
})

// Sort by date (newest first)
const sortedLinks = liveLinks.sort(
	(a: LinkData, b: LinkData) =>
		new Date(b.date).getTime() - new Date(a.date).getTime(),
)

// Apply tag filtering if a tag is selected
const filteredLinks = selectedTag
	? sortedLinks.filter((link: LinkData) => {
			const linkTags = link.tags
				? Array.isArray(link.tags)
					? link.tags
					: link.tags.split(',').map((tag: string) => tag.trim())
				: []
			return linkTags.some(
				(tag: string) => tag.toLowerCase() === selectedTag.toLowerCase(),
			)
		})
	: sortedLinks

// Calculate pagination based on filtered results
const totalLinks = filteredLinks.length
const totalPages = Math.ceil(totalLinks / pageSize)
const startIndex = (currentPage - 1) * pageSize
const endIndex = startIndex + pageSize
const currentPageLinks = filteredLinks.slice(startIndex, endIndex)

// Generate pagination URLs with tag parameter preserved
const baseUrl = '/links'
const tagParam = selectedTag ? `?tag=${encodeURIComponent(selectedTag)}` : ''
const prevPage = currentPage > 1 ? currentPage - 1 : null
const nextPage = currentPage < totalPages ? currentPage + 1 : null

// Create page object to match Astro's pagination structure
const page = {
	data: currentPageLinks,
	currentPage: currentPage,
	lastPage: totalPages,
	url: {
		current: `${baseUrl}/${currentPage}${tagParam}`,
		prev: prevPage ? `${baseUrl}/${prevPage}${tagParam}` : null,
		next: nextPage ? `${baseUrl}/${nextPage}${tagParam}` : null,
	},
}

// Extract all unique tags from all links (reuse the same filtered data)
const allTags = [
	...new Set(
		liveLinks.flatMap((link: LinkData) =>
			link.tags
				? Array.isArray(link.tags)
					? link.tags
					: link.tags.split(',').map((tag: string) => tag.trim())
				: [],
		),
	),
].sort()

// Badge color variants
const badgeColors = [
	'bg-red-50 text-red-700 ring-red-600/20 dark:bg-red-400/10 dark:text-red-400 dark:ring-red-400/20',
	'bg-yellow-50 text-yellow-800 ring-yellow-600/20 dark:bg-yellow-400/10 dark:text-yellow-500 dark:ring-yellow-400/20',
	'bg-green-50 text-green-700 ring-green-600/20 dark:bg-green-400/10 dark:text-green-400 dark:ring-green-400/20',
	'bg-blue-50 text-blue-700 ring-blue-600/20 dark:bg-blue-400/10 dark:text-blue-400 dark:ring-blue-400/20',
	'bg-indigo-50 text-indigo-700 ring-indigo-600/20 dark:bg-indigo-400/10 dark:text-indigo-400 dark:ring-indigo-400/20',
	'bg-purple-50 text-purple-700 ring-purple-600/20 dark:bg-purple-400/10 dark:text-purple-400 dark:ring-purple-400/20',
	'bg-pink-50 text-pink-700 ring-pink-600/20 dark:bg-pink-400/10 dark:text-pink-400 dark:ring-pink-400/20',
	'bg-gray-50 text-gray-600 ring-gray-500/10 dark:bg-gray-400/10 dark:text-gray-400 dark:ring-gray-400/20',
	'bg-orange-50 text-orange-700 ring-orange-600/20 dark:bg-orange-400/10 dark:text-orange-400 dark:ring-orange-400/20',
	'bg-teal-50 text-teal-700 ring-teal-600/20 dark:bg-teal-400/10 dark:text-teal-400 dark:ring-teal-400/20',
]

// Function to get consistent color for a tag
const getTagColor = (tag: string) => {
	const colorIndex =
		tag.split('').reduce((acc, char) => acc + char.charCodeAt(0), 0) %
		badgeColors.length
	return badgeColors[colorIndex]
}
---

<Layout
	title={'Latest Social Links'}
	description="List of social links and interactions."
	noindex={false}
	nofollow={false}>
	<Fragment slot="head">
		<link
			rel="alternate"
			type="application/rss+xml"
			title="Nicolas Deyros - Curated Links"
			href={`${Astro.site}rss-links.xml`}
		/>
	</Fragment>
	<Section ariaLabel="Latest Social Links">
		<div
			class="mb-4 flex flex-col items-center justify-center gap-2 sm:flex-row">
			<h3 class="text-xl font-bold text-slate-800 dark:text-slate-200">
				Latest Social Links
				{
					selectedTag && (
						<span class="text-base font-normal text-slate-600 dark:text-slate-400">
							- filtered by "{selectedTag}"
						</span>
					)
				}
			</h3>
			<a
				href="/rss-links.xml"
				class="inline-flex items-center gap-1.5 rounded-md bg-orange-50 px-3 py-1.5 text-sm font-medium text-orange-700 transition-colors hover:bg-orange-100 dark:bg-orange-400/10 dark:text-orange-400 dark:hover:bg-orange-400/20"
				title="Subscribe to links RSS feed"
				aria-label="Subscribe to links RSS feed">
				<svg class="h-4 w-4" fill="currentColor" viewBox="0 0 20 20">
					<path
						fill-rule="evenodd"
						d="M3.429 2.929c.444-.444 1.143-.444 1.587 0 .444.444.444 1.143 0 1.587a6 6 0 000 8.485c-.444.444-1.143.444-1.587 0-.444-.444-.444-1.143 0-1.587a4 4 0 010-5.656c.444-.444.444-1.143 0-1.587z"
						clip-rule="evenodd">
					</path>
					<path
						fill-rule="evenodd"
						d="M7.05 6.464c.444-.444 1.143-.444 1.587 0 .444.444.444 1.143 0 1.587a2 2 0 010 2.83c-.444.444-1.143.444-1.587 0-.444-.444-.444-1.143 0-1.587.195-.195.195-.512 0-.707-.444-.444-.444-1.143 0-1.587z"
						clip-rule="evenodd">
					</path>
					<circle cx="11" cy="13" r="1"></circle>
				</svg>
				RSS Feed
			</a>
		</div>

		<!-- Mobile Filter Section (visible on mobile only) -->
		<aside class="mb-6 w-full lg:hidden">
			<div class="mb-3 flex items-center justify-center gap-2">
				<span class="text-sm font-medium text-slate-700 dark:text-slate-300">
					Filter by tag:
				</span>
				{
					selectedTag && (
						<a
							href="/links/1"
							class="rounded-md bg-red-100 px-3 py-1 text-xs font-medium text-red-800 transition-colors hover:bg-red-200 dark:bg-red-900 dark:text-red-200 dark:hover:bg-red-800">
							Clear Filter
						</a>
					)
				}
			</div>
			<div class="flex flex-wrap justify-center gap-2">
				{
					allTags.map((tag: string) => (
						<a
							href={`/links/1?tag=${encodeURIComponent(tag)}`}
							class={`tag-filter inline-flex items-center rounded-md px-2 py-1 text-xs font-medium ring-1 transition-colors ring-inset hover:opacity-80 ${getTagColor(tag as string)} ${
								selectedTag === tag ? 'ring-2 ring-blue-500 ring-offset-2' : ''
							}`}>
							{tag}
						</a>
					))
				}
			</div>
		</aside>

		<!-- Desktop Layout with Sidebar -->
		<div class="flex w-full gap-6">
			<!-- Main Content Area -->
			<section class="min-w-0 flex-1">
				<div
					class="flex w-full flex-col items-center gap-4"
					id="links-container">
					{
						page.data.map((l: LinkData, i: number) => (
							<article
								class="article-animate link-item flex w-full max-w-4xl flex-col gap-2 border-b-2 border-slate-200 p-1 md:flex-row dark:border-slate-700"
								style={`animation-delay: ${i * 100}ms`}>
								<div class="flex flex-col gap-1">
									<div class="flex items-center justify-between gap-2">
										<h4 class="mb-1 text-xs font-bold text-slate-900 md:text-lg dark:text-slate-100">
											<a
												href={l.url}
												target="_blank"
												class="truncate transition-colors hover:text-blue-600 hover:underline dark:hover:text-blue-400">
												{l.title}
											</a>
										</h4>
										<span class="hidden md:block">-</span>
										<time
											class="text-xs text-slate-500 dark:text-slate-400"
											datetime={new Date(l.date).toISOString()}>
											{new Date(l.date).toLocaleDateString('en-us', {
												year: '2-digit',
												month: 'short',
												day: 'numeric',
											})}
										</time>
									</div>

									{l.tags && (
										<div class="flex flex-wrap justify-start gap-2">
											{/* Handle both comma-separated strings and arrays */}
											{(Array.isArray(l.tags)
												? l.tags
												: l.tags.split(',').map((tag: string) => tag.trim())
											).map((tag: string) => (
												<span
													class={`inline-flex items-center justify-center rounded-md px-2 py-1 text-xs font-medium ring-1 ring-inset ${getTagColor(tag as string)}`}>
													{tag}
												</span>
											))}
										</div>
									)}
								</div>
							</article>
						))
					}
				</div>

				<!-- No results message -->
				{
					page.data.length === 0 && selectedTag && (
						<div class="mt-8 text-center text-gray-500 dark:text-gray-400">
							<p>No links found for the tag "{selectedTag}".</p>
							<a
								href="/links/1"
								class="mt-2 inline-block text-blue-600 hover:text-blue-800 dark:text-blue-400 dark:hover:text-blue-300">
								‚Üê View all links
							</a>
						</div>
					)
				}

				<!-- Pagination -->
				<Pagination
					current={page.currentPage}
					startUrl={page.currentPage === 1 ? null : `${baseUrl}/1${tagParam}`}
					prevUrl={page.url.prev}
					nextUrl={page.url.next}
					currentUrl={page.url.current}
					lastUrl={page.lastPage}
				/>
			</section>

			<!-- Sidebar with all tags (not filtered by pagination) -->
			<aside class="hidden w-64 flex-shrink-0 lg:block">
				<div class="sticky top-6">
					<div class="mb-4 flex items-center justify-between">
						<h4
							class="text-sm font-semibold text-slate-900 dark:text-slate-100">
							Filter by tag
						</h4>
						{
							selectedTag && (
								<a
									href="/links/1"
									class="rounded-md bg-red-100 px-2 py-1 text-xs font-medium text-red-800 transition-colors hover:bg-red-200 dark:bg-red-900 dark:text-red-200 dark:hover:bg-red-800">
									Clear
								</a>
							)
						}
					</div>

					<div class="flex flex-wrap gap-2">
						{
							allTags.map((tag: string) => (
								<a
									href={`/links/1?tag=${encodeURIComponent(tag)}`}
									class={`tag-filter inline-flex items-center rounded-md px-2 py-1 text-xs font-medium ring-1 transition-colors ring-inset hover:opacity-80 ${getTagColor(tag as string)} ${
										selectedTag === tag
											? 'ring-2 ring-blue-500 ring-offset-2'
											: ''
									}`}>
									{tag}
								</a>
							))
						}
					</div>
				</div>
			</aside>
		</div>
	</Section>

	<script>
		// Animation initialization only
		document.addEventListener('astro:page-load', () => {
			// Re-trigger animations on page navigation
			const articles = document.querySelectorAll('.article-animate')
			articles.forEach((article, i) => {
				;(article as HTMLElement).style.animationDelay = `${i * 100}ms`
			})
		})
	</script>

	<style>
		@keyframes fadeInUp {
			from {
				opacity: 0;
				transform: translateY(30px);
			}
			to {
				opacity: 1;
				transform: translateY(0);
			}
		}
		.article-animate {
			opacity: 0;
			animation: fadeInUp 0.6s forwards;
		}

		.tag-filter {
			text-decoration: none; /* Remove default link underline */
		}

		.tag-filter:hover {
			transform: translateY(-1px);
		}

		/* Ensure sidebar doesn't interfere with main content */
		@media (min-width: 768px) {
			.sticky {
				position: sticky;
				top: 1.5rem;
			}
		}
	</style>
</Layout>
